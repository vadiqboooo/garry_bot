from aiogram import Router
from time import sleep

from aiogram.filters import Command
from aiogram.types import Message
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

from database import add_user, update_user, get_user

from message_file import text
from handlers.admin import send_alert

user = Router()

# ====== –ö–æ–º–∞–Ω–¥—ã ====== #
@user.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ /start"""
    user = message.from_user
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    new_user = await add_user(telegram_id=user.id, username=user.username, phone_number=None)

    
    get_contact_kb = ReplyKeyboardMarkup(
                    keyboard=[
                        [KeyboardButton(text="üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç", request_contact=True)]
                    ],
                    resize_keyboard=True,  # –ü–æ–¥–≥–æ–Ω—è–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                    one_time_keyboard=True  # –°–∫—Ä—ã–≤–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
                )
    
    if new_user:
        await send_alert(message=message)
        await message.answer(text['welcome'])
        sleep(3)
        await message.answer(text['about'], reply_markup=get_contact_kb)
    else:
        user = await get_user(telegram_id=user.id)
        if user.phone_number == '':
            await message.answer(text=text['not_phone'], reply_markup=get_contact_kb)
        else:
            await message.answer(text=text['timing'])


@user.message(lambda message: message.contact is not None)
async def handle_contact(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞"""
    contact = message.contact
    await update_user(telegram_id=contact.user_id, phone_number=contact.phone_number)
    await message.answer(
        text = text['finaly'],
        reply_markup=ReplyKeyboardRemove()  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    )
    await send_alert(message=message, contact=contact)
